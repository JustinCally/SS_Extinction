---
title: "ComparativePlots"
author: "Justin Cally"
date: "03/09/2018"
output: html_document
---

#Phylo Plots

```{r, fig.width = 6.5, fig.height = 6.5}
pdf("Figures/BAMMplot.spec.pdf", width = 20, height = 20)
BAMMplot.spec <- plot.bammdata(MCC.BAMM.ED, 
                          breaksmethod = "jenks", 
                          spex="s", 
                          method = "polar", 
                          lwd=0.5, 
                          tau=0.003, 
                          logcolor = T, 
                          vtheta = 90, 
                          rbf = 0.02,
            pal= c("#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"))
dev.off()
```

Plot phylorate plot, good way of visualizing diversification rates
```{r, fig.width = 6.5, fig.height = 6.5}
pdf("Figures/BAMMplot.spec.tips.pdf", width = 20, height = 20)
BAMMplot.spec.tips <- plot.bammdata(MCC.BAMM.ED, 
                          breaksmethod = "jenks", 
                          spex="s", 
                          method = "polar", 
                          lwd=0.5, 
                          tau=0.003, 
                          logcolor = T, 
                          vtheta = 90, 
                          rbf = 0.02,
                          labels = T,
                          cex = 0.075,
            pal= c("#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"))
addBAMMlegend(BAMMplot.spec, location="bottom", direction = "horizontal", side = 1)

dev.off()
```

Get histogram of extinction rates

```{r}
#BAMMplot.spec[["colordens"]][["kde.y"]] <- log1p(BAMMplot.spec[["colordens"]][["kde.y"]] )
#pdf("figures/BAMMplot_hist.pdf", width = 8, height = 4)
#create phylorate plot to generate output
ratesHistogram(BAMMplot.spec, plotBrks = F, xlab = 'Speciation rate', ylab = 'Frequency', lwd = 0.05)
#dev.off()

```

##Plot for DR mean rate


```{r}
cols <- c("#543005", "#8c510a", "#bf812d", "#dfc27d", "#c0d884",
           brewer.pal(n = 9, name = "YlGn")[4:9])
cols <- c('#B76643','#B76643','#B76643','#B76643','#B47339','#AC8032','#A08E33','#909B3C','#7DA64D', brewer.pal(n = 9, name = "Greens")[5:9], "#00441B", "#00441B", "#00441B")

cols <- c("#543005", "#8c510a", "#bf812d", "#dfc27d", "#c0d884",
           brewer.pal(n = 9, name = "YlGn")[4:9])
# 
# cols <- c(
# '#543005',
# '#8c510a',
# '#fd8d3c',
# '#feb24c',
# '#fed976',
# '#ffeda0',
# #'#f7fcb9',
# '#d9f0a3',
# '#addd8e',
# '#78c679',
# '#41ab5d',
# '#238443',
# '#006837',
# '#006837',
# '#004529',
# '#004529',
# '#004529')
# 
# cols <- c(
# '#211F29',
# '#262B37',
# '#2A3945',
# '#2C4751',
# '#2D565C',
# '#2F6565',
# '#34746C',
# '#3E8470',
# '#4D9371',
# '#60A171',
# '#78B06F',
# '#92BD6D',
# '#B0C96B',
# '#D0D46B'
# )

restricted.data %>% ggplot(aes(x = exp(MCC.DR), y = 0, fill = ..x..))+
  geom_density_ridges_gradient(scale = 3, size = 0.05, gradient_lwd = 0.75)+
  scale_fill_distiller(palette = "YlGn", direction = 1, labels = )+
  theme_minimal()+
  scale_x_continuous(breaks = c(0.02, 0.1, 0.5, 2.5), trans = "log")+
  scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom",
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.line.y = element_blank(), 
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x.bottom = element_line())

 MCC.BAMM.model.data %>% ggplot(aes(x = SDi, y = 0, fill = ..x..))+
  geom_density_ridges_gradient(scale = 3, size = 0.05, gradient_lwd = 0.75)+
  scale_fill_distiller(palette = "OrRd", direction = 1, guide = F)+
  theme_minimal()+
  scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.line.y = element_blank(), 
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x.bottom = element_line())

MCC.BAMM.model.data %>% ggplot(aes(x = range.size.m2, y = 0, fill = ..x..))+
  geom_density_ridges_gradient(scale = 3, size = 0.05, gradient_lwd = 0.75)+
  scale_fill_distiller(palette = "BuPu", direction = 1, guide = F)+
  scale_x_log10()+
  theme_minimal()+
  scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.line.y = element_blank(), 
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x.bottom = element_line())

SS.subset %>% ggplot(aes(x = Sexual_selection_ppca, y = 0, fill = ..x..))+
  geom_density_ridges_gradient(scale = 3, size = 0.05, gradient_lwd = 0.75)+
  scale_fill_distiller(palette = "Greys", direction = 1, guide = F)+
  theme_minimal()+
  scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.line.y = element_blank(), 
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x.bottom = element_line())
```


```{r}
#Get more leasonable intercept for gls slope
SDi.intercept.BAMM <- coef(gls(log(mean.lambda) ~ SDi, data = MCC.BAMM.model.data))[1]

BAMM.scatter <- MCC.BAMM.model.data %>% ggplot(aes(y = mean.lambda, x = SDi, fill = ..x..))+
  # geom_point(data = restricted.data, aes(x = SDi, y = exp(MCC.DR)), color = "gray70")+
  geom_point(shape = 21, stroke = 0.35)+
  scale_fill_distiller(palette = "OrRd", direction = 1, guide = F)+
  scale_y_continuous(breaks = c(0.01,0.1, 1.0), limits = c(0.01, 7), trans = "log")+
  theme_bw()+
  xlab("Sexual Dichromatism")+
  ylab("Speciation Rate (BAMM)")+
    geom_abline(slope = MCC.Lambda.top[["coefficients"]][["SDi"]],
             intercept =  SDi.intercept.BAMM, 
             size = 1)+
  geom_abline(slope = min(BAMM.lambda.pgls.summary %>% 
                            filter(Parameter == "SDi") %>% 
                            select(Estimate)),
             intercept =  SDi.intercept.BAMM, 
             size = .75, 
             linetype = 2)+
  geom_abline(slope = max(BAMM.lambda.pgls.summary %>% 
                            filter(Parameter == "SDi") %>% 
                            select(Estimate)),
             intercept =  SDi.intercept.BAMM, 
             size = .75, 
             linetype = 2)+
    scale_x_continuous(expand = c(0,0.3))+
    theme(panel.grid = element_blank(),
          axis.line = element_line(),
          panel.border = element_blank(),
          plot.margin = unit(c(.5,.5,.5,.5), "cm"))
```

```{r}
grid.arrange(DR.scatter, Range.scatter, nrow = 2)
```

```{r}
newRange <- data.frame(`range.size.m2` = restricted.data$log.range.size,
                         SDi = mean(restricted.data$SDi),
                         NPP = mean(restricted.data$NPP),
                         bioclim4 = mean(restricted.data$bioclim4),
                         residuals.PC1 = mean(restricted.data$residuals.PC1),
                         PC1.LIG = mean(restricted.data$PC1.LIG))
restricted.data$Range.Predict <- predict(MCC.DR.top, newRange)
```



Plotting a tree showing the estimated BAMM speciation rates 

```{r}
#edge.rates <- getMeanBranchLengthTree(MCC.BAMM.ED, rate = "speciation")
#saveRDS(edge.rates, "data/edge.rates.lambda.rds")
edge.rates <- readRDS("data/edge.rates.lambda.rds")
edge.rates.df <- data.frame(edge.rates[["phy"]][["edge"]], edge.rates[["phy"]][["edge.length"]]) %>% `colnames<-`(c("parent", "node", "rate"))

fortified.MCC.tree <- fortify(MCC.BAMM.tree)
fortified.MCC.tree <- left_join(fortified.MCC.tree, edge.rates.df,  by = c("parent", "node"))
```

Creating other plots: 

This is the order of species on the big speciation plot going anti-clockwise:

+ Lepidothrix coeruleocapilla
+ Muscisaxicola capistratus 
+ Cercomacra manu
+ Cranioleuca curtata
+ Malurus pulcherrimus
+ Pachycephala pectoralis pectoralis
+ Paradisaea rubra
+ Mayrornis schistaceus
+ Progne cryptoleuca
+ Acrocephalus australis
+ Zosterops erythropleurus
+ Phainopepla nitens
+ Promerops gurneyi
+ Euplectes franciscanus
+ Euphonia rufiventris
+ Atlapetes leucopterus
+ Geospiza magnirostris
+ Sporophila bouvronides


Plot the SDi val
```{r}
# library(RColorBrewer)
# col <- c(scale_color_distiller(palette = "OrRd", direction = 1), scale_color_distiller(palette = "BuPu", direction = 1))
ggtree.plot <- ggtree(fortified.MCC.tree, aes(color = rate),
                      layout="fan", open.angle = 90, size = 0.175) + 
  xlim(-75, NA)+
  scale_color_distiller(palette = "YlGn", direction = 1, guide = F, trans = "log", breaks=c(0.05, 0.15, 0.5, 1.5))+
  geom_tiplab(size=0.1, color = "black")

    # theme(legend.position = "bottom",
    #     legend.text = element_text(size = 18))

 ggtree.plot <-gheatmap2(ggtree.plot, data = MCC.BAMM.model.data %>% left_join(SS.subset %>% select(TipLabel, Sexual_selection_ppca), by = "TipLabel") %>% select(Sexual_selection_ppca), width=0.05, colnames = FALSE, low = "grey90", high = "black")

#  scale_fill_distiller(palette = "OrRd", direction = 1, na.value = "white", guide = guide_colorbar(direction = "horizontal", label.position = "bottom", barheight = 1.5, barwidth = 25, label.vjust = -0.5))
    
  # theme(legend.position = "bottom",
  #       legend.text = element_text(size = 18))

# ggtree.plot <-gheatmap2(ggtree.plot, data = log(MCC.BAMM.model.data %>% select(range.size.m2)), width=0.05, colnames = FALSE, offset = 3.5)+
# scale_fill_distiller(palette = "BuPu", direction = 1, na.value = "white", guide = guide_colorbar(direction = "horizontal", label.position = "bottom", barheight = 1.5, barwidth = 25, label.vjust = -0.5))+


```

Plot using DR 

```{r}
DR.tips <- MCC.dr.df$es %>% `names<-`(MCC.dr.df$binomial)
# tree.rates <- contMap(MCC.BAMM.tree, DR.tips)
tree.rates.node <- fastAnc(MCC.BAMM.tree, DR.tips)
tree.rates.node.df <- as.list(tree.rates.node)
tree.rates.node.df <- bind_rows(tree.rates.node.df) %>% t()
colnames(tree.rates.node.df) <- "es"

DR.tips.df <- MCC.dr.df %>% select(es, binomial) %>% rename(label = binomial)
node.rates <- rbind(DR.tips.df %>% select(es), tree.rates.node.df)

fortified.DR.tree <- fortify(MCC.BAMM.tree)
fortified.DR.tree <- cbind(fortified.DR.tree, node.rates) %>% rename(rate = es)
```

```{r}
cols <- c("#543005", "#8c510a", "#bf812d", "#dfc27d", "#d9ef8b",
           brewer.pal(n = 9, name = "YlGn")[4:9])
display.brewer.pal(n = 11, name = "RdYlGn")[4:11]
#cols <- c("#045a8d", "#74a9cf", "#ffd92f", "#d9f0a3", "#78c679", "#005a32")
#20 x 20 plots
ggtree.plot.dr <- ggtree(fortified.DR.tree, aes(color =  rate),
                      layout="fan", open.angle = 90, size = 0.175) + 
  xlim(-75, NA)+
  scale_color_distiller(palette = "YlGn", direction = 1, trans = "log", breaks=c(0.05, 0.15, 0.5, 1.5))+
  theme(legend.position = "bottom",
        legend.text = element_text(size = 18))

# ggtree.plot.dr.1 <- gheatmap2(ggtree.plot.dr, data = MCC.BAMM.model.data %>% `rownames<-`(MCC.BAMM.model.data$TipLabel) %>% select(SDi), width=0.05, colnames = FALSE)  +
# scale_fill_distiller(palette = "OrRd", direction = 1, na.value = "white", guide = F)
# 
# ggtree.plot.dr.2 <- ggtree.plot.dr.1 + new_scale_fill() 
# ggtree.plot.dr.2 <- gheatmap2(ggtree.plot.dr.2, data = MCC.BAMM.model.data %>% `rownames<-`(MCC.BAMM.model.data$TipLabel) %>% select(SDi), width=0.05, colnames = FALSE)  +
# scale_fill_distiller(palette = "BuPu", direction = 1, na.value = "white", guide = F)
# 
# ggtree.plot.dr.3 <- ggtree.plot.dr.2 + new_scale_fill() 
# ggtree.plot.dr.3 <- gheatmap2(ggtree.plot.dr.3, data = MCC.BAMM.model.data %>% `rownames<-`(MCC.BAMM.model.data$TipLabel) %>% left_join(SS.subset %>% select(TipLabel, Sexual_selection_ppca), by = "TipLabel") %>% select(Sexual_selection_ppca), width=0.05, colnames = FALSE)  +
# scale_fill_distiller(palette = "Greys", direction = 1, na.value = "white", guide = F)

ggtree.plot.dr.3 <- gheatmap2(ggtree.plot.dr, data = MCC.BAMM.model.data %>% left_join(SS.subset %>% select(TipLabel, Sexual_selection_ppca), by = "TipLabel")%>% `rownames<-`(MCC.BAMM.model.data$TipLabel) %>% select(Sexual_selection_ppca), width=0.05, colnames = FALSE, low = "Grey90", high = "Black")

#     theme(legend.position = "bottom",
#         legend.text = element_text(size = 18))
# 
# ggtree.plot.dr.h <- gheatmap2(ggtree.plot.dr, data = MCC.BAMM.model.data %>% select(SDi), width=0.5, colnames = FALSE, low = "grey90", high = "black")


```


```{r}

Lepidothrix.coeruleocapilla.data <- restricted.data %>% filter(TipLabel == "Lepidothrix_coeruleocapilla")

LC.bioclim4 <- data.frame(
  value = rnorm(1000, mean = Lepidothrix.coeruleocapilla.data$bioclim4, sd = Lepidothrix.coeruleocapilla.data$se.bioclim4))

LC.bioclim4$name <- "bioclim4"

LC.bioclim4 %>% ggplot()+
  geom_density_ridges(aes(x = value/10, y = 0), rel_min_height = 0.005, fill = "#fc8d62")+
  scale_y_discrete(expand = c(0,0))+
  ylab("")+
  xlab("Temperature Seasonality")+

  theme_bw()+
  
  theme(
        text = element_text(size=18),
        panel.border= element_blank(),
        axis.line.y =element_blank(),
        axis.line.x = element_line(),
        axis.ticks.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(), 
        legend.text = element_text(size=18), 
        legend.title=element_text(size=18, face = "bold"),
        axis.title.x = element_text(hjust = 0.5, size = 24),
        axis.title.y = element_text(size = 18, hjust = 0.35, margin = margin(r=-10)),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 18))
```

```{r}
Lepidothrix.coeruleocapilla.data <- restricted.data %>% filter(TipLabel == "Lepidothrix_coeruleocapilla")

LC.NPP <- data.frame(
  value = rnorm(1000, mean = Lepidothrix.coeruleocapilla.data$NPP, sd = Lepidothrix.coeruleocapilla.data$NPP.se))

LC.NPP$name <- "NPP"

LC.NPP %>% ggplot()+
  geom_density_ridges(aes(x = value/10, y = 0), rel_min_height = 0.005, fill = "#a6d854")+
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(limits = c(1910, 2010))+
  ylab("")+
  xlab("NPP")+

  theme_bw()+
  
  theme(
        text = element_text(size=18),
        panel.border= element_blank(),
        axis.line.y =element_blank(),
        axis.line.x = element_line(),
        axis.ticks.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(), 
        legend.text = element_text(size=18), 
        legend.title=element_text(size=18, face = "bold"),
        axis.title.x = element_text(hjust = 0.5, size = 24),
        axis.title.y = element_text(size = 18, hjust = 0.35, margin = margin(r=-10)),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 18))

LC.NPP <- data.frame(
  value = rnorm(1000, mean = Lepidothrix.coeruleocapilla.data$NPP, sd = Lepidothrix.coeruleocapilla.data$NPP.se))

LC.NPP$name <- "NPP"

LC.NPP %>% ggplot()+
  geom_density_ridges(aes(x = value/10, y = 0), rel_min_height = 0.005, fill = "#a6d854")+
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(limits = c(1910, 2010))+
  ylab("")+
  xlab("NPP")+

  theme_bw()+
  
  theme(
        text = element_text(size=18),
        panel.border= element_blank(),
        axis.line.y =element_blank(),
        axis.line.x = element_line(),
        axis.ticks.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(), 
        legend.text = element_text(size=18), 
        legend.title=element_text(size=18, face = "bold"),
        axis.title.x = element_text(hjust = 0.5, size = 24),
        axis.title.y = element_text(size = 18, hjust = 0.35, margin = margin(r=-10)),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 18))
```

```{r}
#read nexus
manakin.trees <- read.nexus(file.choose())
#get MCC
manakin.tree <- maxCladeCred(manakin.trees)

manakin.DR <- calculate.log.es(manakin.tree)
```






#Figure 1 in manuscript (filtered model results) 

```{r, fig.height = 8, fig.width = 4, message = FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
library(Cairo)
library(data.table)

#Cols for plot: 
cols1 <- c("#8856a7", "#c6dbef")
cols2 <- c("#8856a7", "#fc8d59")

#Read in the 1000 tree summary df and the MCC tree model
DR.pgls.summary <- readRDS("data/DR.pgls.summary.rds")
MCC.DR.top <- readRDS('data/MCC.DR.top.rds')
MCC.DR.summary <-  data.frame(MCC.DR.top$coefficients,
                              confint(MCC.DR.top),
                              coef(summary(MCC.DR.top))[,2], #Std.Error
                              coef(summary(MCC.DR.top))[,3], #t-val
                              coef(summary(MCC.DR.top))[,4], #pval
                              MCC.DR.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name"))

#Now plot this for Node Density (ND):  

ND.pgls.summary <- readRDS("data/ND.pgls.summary.rds")
MCC.ND.top <- readRDS('data/MCC.ND.top.rds')
MCC.ND.summary <- data.frame(MCC.ND.top$coefficients,
                              confint(MCC.ND.top),
                              coef(summary(MCC.ND.top))[,2], #Std.Error
                              coef(summary(MCC.ND.top))[,3], #t-val
                              coef(summary(MCC.ND.top))[,4], #pval
                              MCC.ND.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name"))

parameter_names <- c(
                    `bioclim4` = "Temperature Seasonality",
                    `log(range.size.m2)` = "Range Size (log-transformed)",
                    `NPP` = "NPP",
                    `PC1.LIG` = "Long-term Temperature Variation",
                    `residuals.PC1` = "Spatial Temperature Variation",
                    `SDi` = "Sexual Dichromatism"
                    )



DR.plot.sub <-DR.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")) %>% 
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  #geom_errorbarh(aes(xmin = LCI, xmax = UCI, colour = Parameter), position = position_jitter(seed = 1), height = 0)+
  geom_point(shape = 21, alpha = 0.25, size = 0.75, position = position_jitter(seed = 1))+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

DR.plot.sub <- DR.plot.sub + geom_errorbarh(data = MCC.DR.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = MCC.DR.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 6, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols1)+
  scale_color_manual(values = cols1)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(lambda['DR'], sep = "")))


ND.plot.sub <-ND.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")) %>% 
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

ND.plot.sub <- ND.plot.sub + geom_errorbarh(data = MCC.ND.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = MCC.ND.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,0.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 6, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols1)+
  scale_color_manual(values = cols1)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(lambda['ND'], sep = "")))

BAMM.lambda.pgls.models <- readRDS("data/BAMM.lambda.pgls.models.rds")

BAMM.lambda.pgls.summary <- lapply(BAMM.lambda.pgls.models, function(x) {
  data.frame(x$coefficients, confint(x)) %>% tibble::rownames_to_column()
})

#Now plot this for Lambda

MCC.Lambda.top <- readRDS('data/MCC.Lambda.top.rds')
MCC.lambda.summary <- data.frame(MCC.Lambda.top$coefficients,
                              confint(MCC.Lambda.top),
                              coef(summary(MCC.Lambda.top))[,2], #Std.Error
                              coef(summary(MCC.Lambda.top))[,3], #t-val
                              coef(summary(MCC.Lambda.top))[,4], #pval
                              MCC.Lambda.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name"))

BAMM.lambda.pgls.summary <- bind_rows(BAMM.lambda.pgls.summary) %>% `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI"))

  # for (x in unique(BAMM.lambda.pgls.summary$Parameter)[2:7]){
  #   filter(Parameter == x & between(Estimate, left = as.numeric(hpd.Lambda.top[1,x]), right = as.numeric(hpd.Lambda.top[2,x])))
  #   } 


remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

BAMM.lambda.pgls.summary.RO <- data.table::dcast(BAMM.lambda.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), Estimate ~ Parameter, value.var = "Estimate")
BAMM.lambda.pgls.summary.RO$Estimate <- NULL
BAMM.lambda.pgls.summary.RO <- sapply(BAMM.lambda.pgls.summary.RO, function(x) {
  remove_outliers(x, na.rm = T)})
BAMM.lambda.pgls.summary.RO <-melt(BAMM.lambda.pgls.summary.RO) %>% na.omit()
BAMM.lambda.pgls.summary.RO$Var1 <- NULL
colnames(BAMM.lambda.pgls.summary.RO) <- c("Parameter", "Estimate")

BAMM.lambda.plot.sub <- BAMM.lambda.pgls.summary.RO %>%
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

BAMM.lambda.plot.sub <- BAMM.lambda.plot.sub + geom_errorbarh(data = MCC.lambda.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = MCC.lambda.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,0.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 7, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols1)+
  scale_color_manual(values = cols1)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(lambda['BAMM'], sep = "")))


#Figure for extinction

BAMM.mu.pgls.models <- readRDS("data/BAMM.mu.pgls.models.rds")

BAMM.mu.pgls.summary <- lapply(BAMM.mu.pgls.models, function(x) {
  data.frame(x$coefficients, confint(x)) %>% tibble::rownames_to_column()
})

BAMM.mu.pgls.summary <- bind_rows(BAMM.mu.pgls.summary) %>% `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI"))

#Now plot this for Lambda

MCC.Mu.top <- readRDS('data/MCC.Mu.top.rds')
MCC.mu.summary <- data.frame(MCC.Mu.top$coefficients,
                              confint(MCC.Mu.top),
                              coef(summary(MCC.Mu.top))[,2], #Std.Error
                              coef(summary(MCC.Mu.top))[,3], #t-val
                              coef(summary(MCC.Mu.top))[,4], #pval
                              MCC.Mu.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% 
  tibble::rownames_to_column() %>% 
  `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name"))

#Get rid of outliers
BAMM.mu.pgls.summary.RO <- data.table::dcast(BAMM.mu.pgls.summary %>% dplyr::select(Parameter,Estimate) %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), Estimate ~ Parameter, value.var = "Estimate")
BAMM.mu.pgls.summary.RO$Estimate <- NULL
BAMM.mu.pgls.summary.RO <- sapply(BAMM.mu.pgls.summary.RO, function(x) {
  remove_outliers(x, na.rm = T)})
BAMM.mu.pgls.summary.RO <-melt(BAMM.mu.pgls.summary.RO) %>% na.omit()
BAMM.mu.pgls.summary.RO$Var1 <- NULL
colnames(BAMM.mu.pgls.summary.RO) <- c("Parameter", "Estimate")

BAMM.Mu.plot.sub <-BAMM.mu.pgls.summary.RO %>%
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

BAMM.Mu.plot.sub <- BAMM.Mu.plot.sub + geom_errorbarh(data = MCC.mu.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = MCC.mu.summary %>% filter(Parameter %in% c("log(range.size.m2)", "SDi")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,0.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 7, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols1)+
  scale_color_manual(values = cols1)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(mu['BAMM'], sep = "")))

Subset.DR.pgls.summary <- readRDS("data/Subset.DR.pgls.summary.rds")
Subset.ND.pgls.summary <- readRDS("data/Subset.ND.pgls.summary.rds")

### MCC
Subset.MCC.DR.top <- readRDS('data/Subset.MCC.DR.top.rds')

Subset.MCC.DR.summary <- data.frame(Subset.MCC.DR.top$coefficients,
                              confint(Subset.MCC.DR.top),
                              coef(summary(Subset.MCC.DR.top))[,2], #Std.Error
                              coef(summary(Subset.MCC.DR.top))[,3], #t-val
                              coef(summary(Subset.MCC.DR.top))[,4], #pval
                              Subset.MCC.DR.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% tibble::rownames_to_column()

colnames(Subset.MCC.DR.summary) <- c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name")

parameter_names <- c(
                    `bioclim4` = "Temperature Seasonality",
                    `log(range.size.m2)` = "Range Size (log-transformed)",
                    `NPP` = "NPP",
                    `PC1.LIG` = "Long-term Temperature Variation",
                    `residuals.PC1` = "Spatial Temperature Variation",
                    `Sexual_selection_ppca` = "Sexual Selection"
                    )

Subset.DR.pgls.summary$Parameter = factor(Subset.DR.pgls.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.MCC.DR.summary$Parameter = factor(Subset.MCC.DR.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.DR.plot.sub <-Subset.DR.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")) %>% 
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

Subset.DR.plot.sub <- Subset.DR.plot.sub + geom_errorbarh(data = Subset.MCC.DR.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = Subset.MCC.DR.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 6, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols2)+
  scale_color_manual(values = cols2)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(lambda['DR'], sep = "")))

####################################
#For ND

Subset.MCC.ND.top <- readRDS('data/Subset.MCC.ND.top.rds')

Subset.MCC.ND.summary <- data.frame(Subset.MCC.ND.top$coefficients,
                              confint(Subset.MCC.ND.top),
                              coef(summary(Subset.MCC.ND.top))[,2], #Std.Error
                              coef(summary(Subset.MCC.ND.top))[,3], #t-val
                              coef(summary(Subset.MCC.ND.top))[,4], #pval
                              Subset.MCC.ND.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% tibble::rownames_to_column()

colnames(Subset.MCC.ND.summary) <- c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name")

Subset.ND.pgls.summary$Parameter = factor(Subset.ND.pgls.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.MCC.ND.summary$Parameter = factor(Subset.MCC.ND.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.ND.plot.sub <-Subset.ND.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")) %>% 
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

Subset.ND.plot.sub <- Subset.ND.plot.sub + geom_errorbarh(data = Subset.MCC.ND.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = Subset.MCC.ND.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 6, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols2)+
  scale_color_manual(values = cols2)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(lambda['ND'], sep = "")))

######################

#For Lambda
Subset.BAMM.lambda.pgls.models <- readRDS("data/Subset.BAMM.lambda.pgls.models.rds")
Subset.MCC.Lambda.top <- readRDS('data/Subset.MCC.Lambda.top.rds')

Subset.Lambda.pgls.summary <- lapply(Subset.BAMM.lambda.pgls.models, function(x) {
  data.frame(x$coefficients, confint(x)) %>% tibble::rownames_to_column()
})

Subset.Lambda.pgls.summary <- bind_rows(Subset.Lambda.pgls.summary) %>% `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI"))

#MCC

Subset.MCC.Lambda.summary <- data.frame(Subset.MCC.Lambda.top$coefficients,
                              confint(Subset.MCC.Lambda.top),
                              coef(summary(Subset.MCC.Lambda.top))[,2], #Std.Error
                              coef(summary(Subset.MCC.Lambda.top))[,3], #t-val
                              coef(summary(Subset.MCC.Lambda.top))[,4], #pval
                              Subset.MCC.Lambda.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% tibble::rownames_to_column()

colnames(Subset.MCC.Lambda.summary) <- c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name")


Subset.Lambda.pgls.summary$Parameter = factor(Subset.Lambda.pgls.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.MCC.Lambda.summary$Parameter = factor(Subset.MCC.Lambda.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.Lambda.pgls.summary.RO <- data.table::dcast(Subset.Lambda.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), Estimate ~ Parameter, value.var = "Estimate")
Subset.Lambda.pgls.summary.RO$Estimate <- NULL
Subset.Lambda.pgls.summary.RO <- sapply(Subset.Lambda.pgls.summary.RO, function(x) {
  remove_outliers(x, na.rm = T)})
Subset.Lambda.pgls.summary.RO <-melt(Subset.Lambda.pgls.summary.RO) %>% na.omit()
Subset.Lambda.pgls.summary.RO$Var1 <- NULL
colnames(Subset.Lambda.pgls.summary.RO) <- c("Parameter", "Estimate")


Subset.Lambda.plot.sub <-Subset.Lambda.pgls.summary.RO %>% 
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

Subset.Lambda.plot.sub <- Subset.Lambda.plot.sub + geom_errorbarh(data = Subset.MCC.Lambda.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = Subset.MCC.Lambda.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 6, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols2)+
  scale_color_manual(values = cols2)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(lambda['BAMM'], sep = "")))

######################

#For Mu

Subset.BAMM.Mu.pgls.models <- readRDS("data/Subset.BAMM.mu.pgls.models.rds")
Subset.MCC.Mu.top <- readRDS('data/Subset.MCC.Mu.top.rds')

Subset.Mu.pgls.summary <- lapply(Subset.BAMM.Mu.pgls.models, function(x) {
  data.frame(x$coefficients, confint(x)) %>% tibble::rownames_to_column()
})
Subset.Mu.pgls.summary <- bind_rows(Subset.Mu.pgls.summary) %>% `colnames<-`(c("Parameter", "Estimate", "LCI", "UCI"))

#MCC

Subset.MCC.Mu.summary <- data.frame(Subset.MCC.Mu.top$coefficients,
                              confint(Subset.MCC.Mu.top),
                              coef(summary(Subset.MCC.Mu.top))[,2], #Std.Error
                              coef(summary(Subset.MCC.Mu.top))[,3], #t-val
                              coef(summary(Subset.MCC.Mu.top))[,4], #pval
                              Subset.MCC.Mu.top[["modelStruct"]][["corStruct"]][1], #lambda value
                              model = "MCC_model") %>% tibble::rownames_to_column()

colnames(Subset.MCC.Mu.summary) <- c("Parameter", "Estimate", "LCI", "UCI", "SE", "tval", "pval" , "lambda" ,"model_name")

Subset.Mu.pgls.summary$Parameter = factor(Subset.Mu.pgls.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))

Subset.MCC.Mu.summary$Parameter = factor(Subset.MCC.Mu.summary$Parameter, levels=c('bioclim4','log(range.size.m2)','NPP','PC1.LIG', 'residuals.PC1', 'Sexual_selection_ppca'))


Subset.Mu.pgls.summary.RO <- data.table::dcast(Subset.Mu.pgls.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), Estimate ~ Parameter, value.var = "Estimate")
Subset.Mu.pgls.summary.RO$Estimate <- NULL
Subset.Mu.pgls.summary.RO <- sapply(Subset.Mu.pgls.summary.RO, function(x) {
  remove_outliers(x, na.rm = T)})
Subset.Mu.pgls.summary.RO <-melt(Subset.Mu.pgls.summary.RO) %>% na.omit()
Subset.Mu.pgls.summary.RO$Var1 <- NULL
colnames(Subset.Mu.pgls.summary.RO) <- c("Parameter", "Estimate")

Subset.Mu.plot.sub <-Subset.Mu.pgls.summary.RO %>% 
  ggplot(aes(x = Estimate, y = Parameter, fill = Parameter)) +
  geom_density(aes(y = ..scaled..),
               position = position_nudge(y= 0.6))+
  geom_jitter(shape = 21, alpha = 0.25, size = 0.75)+
  geom_vline(xintercept = 0)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        legend.position = "none")

Subset.Mu.plot.sub <- Subset.Mu.plot.sub + geom_errorbarh(data = Subset.MCC.Mu.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
                 aes(xmin = LCI,
                     xmax = UCI, y = Parameter,
                     color = Parameter), 
                 height = 0, show.legend = F, 
                 position = position_nudge(y= -0.75))+
  
  geom_point(data = Subset.MCC.Mu.summary %>% filter(Parameter %in% c("log(range.size.m2)", "Sexual_selection_ppca")), 
             aes(x = Estimate, y = Parameter, fill = Parameter), 
             shape=21, color = "grey20",
             size = 3,
             position = position_nudge(y= -0.75)) +
  scale_y_discrete(expand = c(0.5,.5))+
  facet_wrap(~ Parameter, scales = "free", nrow = 6, labeller = as_labeller(parameter_names))+
  scale_fill_manual(values = cols2)+
  scale_color_manual(values = cols2)+
  theme(panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7),
        plot.title = element_text(hjust = 0.5),
        plot.margin=unit(c(.5,.5,.5,.5),"cm"))+
  ggtitle(expression(paste(mu['BAMM'], sep = "")))

#########################################
```

Add the scatter plots

```{r}
library(nlme)
# #Get more leasonable intercept for gls slope
# SDi.intercept <- coef(gls(MCC.DR ~ SDi, data = restricted.data))[1]
# 
# DR.scatter <- restricted.data %>% ggplot(aes(y = exp(MCC.DR), x = SDi, fill = ..x..))+
#   geom_point(shape = 21, stroke = 0.35)+
#   scale_fill_distiller(palette = "OrRd", direction = 1, guide = F)+
#   theme_bw()+
#   scale_y_continuous(breaks = c(0.01,0.1, 1.0), limits = c(0.01, 7), trans = "log")+
#   scale_x_continuous(expand = c(0,0.3))+
#   xlab("Sexual Dichromatism")+
#   ylab("Speciation Rate")+
#   geom_smooth(method = "glm", se = F, color = "black", linetype = 5)+ 
#     theme(panel.grid = element_blank(),
#           axis.line = element_line(),
#           panel.border = element_blank(),
#           plot.margin = unit(c(.5,.5,.5,.5), "cm"))

###################
SS.intercept <- coef(gls(MCC.DR ~ Sexual_selection_ppca, data = SS.subset))[1]

DR.SS.scatter <- SS.subset %>% ggplot(aes(y = exp(MCC.DR), x = Sexual_selection_ppca, fill = ..x..))+
  geom_point(shape = 21, stroke = 0.35, alpha = 0.6)+
  scale_fill_gradient(low = "#fdae6b", high = "#e6550d", guide = F)+
  geom_text(aes(x = max(SS.subset$Sexual_selection_ppca, na.rm = T), y = max(c(exp(SS.subset$MCC.DR)), exp(restricted.data$MCC.DR))), label = paste0("n = ", prettyNum(nrow(SS.subset), big.mark = ",")), fontface = 3, vjust = "inward", hjust = "inward")+
  theme_bw()+
  scale_y_continuous(breaks = c(0.01,0.1, 1.0), limits = c(0.01, 7), trans = "log")+
  scale_x_continuous(expand = c(0,0.3))+
  xlab("Sexual Selection")+
  ylab(expression(paste("Speciation Rate (",lambda['DR'], ') ', sep = "")))+
  geom_smooth(method = "glm", se = F, color = "black", linetype = 5)+ 
    theme(panel.grid = element_blank(),
          axis.line = element_line(),
          panel.border = element_blank(),
          plot.margin = unit(c(.5,2,.5,2), "cm"))

#Get more leasonable intercept for gls slope
range.model <- coef(gls(MCC.DR ~ log(range.size.m2), 
                            data = restricted.data))

newRange <- data.frame(`range.size.m2` = restricted.data$range.size,
                         SDi = mean(restricted.data$SDi),
                         NPP = mean(restricted.data$NPP),
                         bioclim4 = mean(restricted.data$bioclim4),
                         residuals.PC1 = mean(restricted.data$residuals.PC1),
                         PC1.LIG = mean(restricted.data$PC1.LIG))
restricted.data$Range.Predict <- predict(MCC.DR.top, newRange)

Range.scatter <- restricted.data %>% ggplot(aes(y = exp(MCC.DR), x = range.size.m2, fill = ..x..))+
  geom_point(shape = 21, stroke = 0.35, alpha = 0.6)+
  scale_fill_gradient(low = "#bcbddc", high = "#54278f", guide = F)+
  geom_text(aes(x = max(restricted.data$range.size.m2, na.rm = T), y = max(c(exp(restricted.data$MCC.DR)), exp(SS.subset$MCC.DR))), label = paste0("n = ", prettyNum(nrow(restricted.data), big.mark = ",")), fontface = 3, vjust = "inward", hjust = "inward")+
  theme_bw()+
  scale_y_continuous(breaks = c(0.01,0.1, 1.0), limits = c(0.01, 7), trans = "log")+
  scale_x_continuous(expand = c(0,0.3), trans = "log", breaks = c(1, 1*(10^7), 1*(10^10), 1*(10^13)))+
  xlab("Range Size")+
  ylab(expression(paste("Speciation Rate (",lambda['DR'], ') ', sep = "")))+
    geom_smooth(method = "glm", se = F, color = "black", linetype = 5)+
    theme(panel.grid = element_blank(),
          axis.line = element_line(),
          panel.border = element_blank(),
          plot.margin = unit(c(.5,2,.5,2), "cm"))

```



```{r}
library(gridExtra)
ggsave(file = "Figures/Estimates_and_scatter.pdf", width = 12, height = 10, device = cairo_pdf,
plot = grid.arrange(
  symmetrise_scale(DR.plot.sub, "x"),
  symmetrise_scale(ND.plot.sub, "x"),
  symmetrise_scale(BAMM.lambda.plot.sub, "x"),
  symmetrise_scale(BAMM.Mu.plot.sub, "x"),
  Range.scatter,
  symmetrise_scale(Subset.DR.plot.sub, "x"),
  symmetrise_scale(Subset.ND.plot.sub, "x"),
  symmetrise_scale(Subset.Lambda.plot.sub, "x"),
  symmetrise_scale(Subset.Mu.plot.sub, "x"),
  DR.SS.scatter,
  layout_matrix = rbind(c(1,2,3,4),
                        c(5,5,10,10),
                        c(6,7,8,9))
))

ggsave(file = "Figures/Estimates_and_scatter.pdf", width = 12, height = 10, device = cairo_pdf,
plot = symmetrise_scale(DR.plot.sub, "x"),
)
```







